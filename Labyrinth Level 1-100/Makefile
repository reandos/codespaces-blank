# ============================================================
#  Makefile â€“ Labirinth Level 1â€“100
# ============================================================
# Dieses Makefile steuert den kompletten Build-Prozess.
# Es kompiliert das Spiel, verwaltet den Smoke-Test
# und bietet Komfort-Kommandos (run, clean, debug, usw.).
# ------------------------------------------------------------
# Wichtig:
#   â€¢ Jede Befehlszeile MUSS mit einem echten Tab beginnen!
#   â€¢ Pfade und Namen entsprechen deiner Projektstruktur.
# ============================================================

# ------------------------------------------------------------
# Compiler & Optionen
# ------------------------------------------------------------
CC      := gcc
CSTD    := -std=c11
WARN    := -Wall -Wextra -Wshadow -Wconversion
OPT     := -O2
INC     := -Iinclude
CFLAGS  := $(CSTD) $(WARN) $(OPT) $(INC)
LDFLAGS :=

# ------------------------------------------------------------
# Quellen und Ausgabedateien
# ------------------------------------------------------------
SRC := \
	src/main.c \
	src/game.c \
	src/maze.c \
	src/io.c \
	src/level.c

OBJ := $(SRC:.c=.o)
DEP := $(OBJ:.o=.d)

BIN := labyrinth

# ------------------------------------------------------------
# Standardziel (wird bei â€žmakeâ€œ ohne Argument gebaut)
# ------------------------------------------------------------
.PHONY: all
all: $(BIN)
	@echo "âœ… Build abgeschlossen: Starte mit ./$(BIN) 1"

# ------------------------------------------------------------
# Linkschritt (fÃ¼hrt alle .o-Dateien zusammen)
# ------------------------------------------------------------
$(BIN): $(OBJ)
	$(CC) $(OBJ) -o $@ $(LDFLAGS)

# ------------------------------------------------------------
# Kompilierung einzelner C-Dateien â†’ .o + .d (AbhÃ¤ngigkeitsdateien)
# ------------------------------------------------------------
src/%.o: src/%.c
	$(CC) $(CFLAGS) -MMD -MP -c $< -o $@

# ------------------------------------------------------------
# Smoke-Test (Mini-Test fÃ¼r Maze/IO)
# ------------------------------------------------------------
SMOKE_SRC := tests/smoke.c src/maze.c src/io.c src/level.c
SMOKE_OBJ := $(SMOKE_SRC:.c=.o)

.PHONY: smoke
smoke: $(SMOKE_OBJ)
	$(CC) $(SMOKE_OBJ) -o smoke $(LDFLAGS)
	@echo "ðŸ‘‰ Smoke-Test erstellt. Starte mit: ./smoke"

# ------------------------------------------------------------
# Komfort-Kommandos
# ------------------------------------------------------------
.PHONY: run runl
run: $(BIN)
	./$(BIN) 1

# Beispiel: make runl L=37  â†’ startet Level 37
L ?= 1
runl: $(BIN)
	./$(BIN) $(L)

# ------------------------------------------------------------
# AufrÃ¤umen und Wartung
# ------------------------------------------------------------
.PHONY: clean rebuild tidy reset debug help

clean:
	@rm -f $(OBJ) $(SMOKE_OBJ) $(DEP) $(BIN) smoke
	@echo "ðŸ§¹ Clean abgeschlossen."

rebuild: clean all

tidy: clean

# Voll-Reset (lÃ¶scht temporÃ¤re Dateien, Caches, Logs)
reset: clean
	@find . -type f -name "*~" -delete
	@find . -type f -name "#*#" -delete
	@find . -type f -name "*.log" -delete
	@find . -type f -name "*.tmp" -delete
	@echo "ðŸ—‘ï¸  Reset abgeschlossen."

# Debug-Ausgabe fÃ¼r Build-Fehleranalyse
debug:
	@echo "CC       = $(CC)"
	@echo "CFLAGS   = $(CFLAGS)"
	@echo "SRC      = $(SRC)"
	@echo "OBJ      = $(OBJ)"
	@echo "BIN      = $(BIN)"
	@echo "LDFLAGS  = $(LDFLAGS)"

# Kurze Ãœbersicht der verfÃ¼gbaren Targets
help:
	@echo "================ Makefile Hilfe ================"
	@echo "make            â€“ Kompiliert das Spiel (Standard)"
	@echo "make run        â€“ Startet Spiel bei Level 1"
	@echo "make runl L=37  â€“ Startet direkt bei Level 37"
	@echo "make smoke      â€“ Erstellt und startet den Smoke-Test"
	@echo "make clean      â€“ LÃ¶scht .o/.d/Binaries"
	@echo "make rebuild    â€“ Clean + Build"
	@echo "make reset      â€“ VollstÃ¤ndiger Reset (inkl. temporÃ¤rer Dateien)"
	@echo "make debug      â€“ Zeigt Build-Parameter"
	@echo "make tidy       â€“ Alias fÃ¼r clean"
	@echo "================================================"

# ------------------------------------------------------------
# Automatische Einbindung der AbhÃ¤ngigkeitsdateien
# ------------------------------------------------------------
-include $(DEP)
